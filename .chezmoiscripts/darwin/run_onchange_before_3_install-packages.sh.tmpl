#!/bin/bash

set -eufo pipefail

# ensure brew is in PATH
if [ -x /opt/homebrew/bin/brew ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -x /usr/local/bin/brew ]; then
  eval "$(/usr/local/bin/brew shellenv)"
fi

{{ $brews := (default (list) .macos_brew_formulae) | sortAlpha | uniq -}}
{{ $casks := (default (list) .macos_brew_casks) | sortAlpha | uniq -}}

brew bundle --file=/dev/stdin <<'EOBREW'
{{ range $brews -}}
brew "{{ . }}"
{{ end -}}
{{ range $casks -}}
cask "{{ . }}"
{{ end }}
EOBREW

# Set zsh as the default shell if not already
if [ "$SHELL" != "$(command -v zsh)" ]; then
  echo " Setting default shell to zsh..."
  chsh -s "$(command -v zsh)" || true
fi

# Enable SSH server (Remote Login)
echo " Enabling SSH server (Remote Login)..."
sudo systemsetup -setremotelogin on 2>/dev/null || true

echo "Installing/upgrading Claude Code via native installer..."
if ! curl -fsSL https://claude.ai/install.sh | bash; then
  echo "Warning: Claude Code installer failed." >&2
fi