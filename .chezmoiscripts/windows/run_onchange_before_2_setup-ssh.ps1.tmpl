$ErrorActionPreference = 'Stop'

function Ensure-WindowsOpenSSH {
  $sshPath = Join-Path $env:SystemRoot 'System32\OpenSSH\ssh.exe'
  if (Test-Path $sshPath) {
    Write-Host '[INFO] Windows OpenSSH Client already installed.'
    return
    
  }

  Write-Host '[INFO] Installing Windows OpenSSH Client capability...'
  try {
    $capability = Get-WindowsCapability -Online -Name 'OpenSSH.Client~~~~0.0.1.0' -ErrorAction Stop
    if ($capability.State -ne 'Installed') {
      Add-WindowsCapability -Online -Name $capability.Name *>$null
      Write-Host '[INFO] Windows OpenSSH Client installed.'
    } else {
      Write-Host '[INFO] Windows OpenSSH Client reported as installed after check.'
    }
  } catch {
    Write-Host ('[ERROR] Unable to ensure Windows OpenSSH Client: {0}' -f $_.Exception.Message) -ForegroundColor Red
  }
}

Ensure-WindowsOpenSSH

# After installation, winget adds to PATH but it doesn't take effect in current session
# Find 1Password executables dynamically and add to PATH persistently
function Add-ToPathIfNeeded {
  param([string]$Dir)

  # Add to current session
  if ($env:PATH -notlike "*$Dir*") {
    $env:PATH = "$Dir;$env:PATH"
  }

  # Add to user PATH persistently via registry
  try {
    $userPath = [Environment]::GetEnvironmentVariable('PATH', 'User')
    if ($userPath -notlike "*$Dir*") {
      $newPath = "$Dir;$userPath"
      [Environment]::SetEnvironmentVariable('PATH', $newPath, 'User')
      Write-Host ("[INFO] Added '{0}' to User PATH persistently." -f $Dir)
    }
  } catch {
    Write-Host ("[WARN] Could not persist '{0}' to User PATH: {1}" -f $Dir, $_.Exception.Message) -ForegroundColor Yellow
  }
}

function Ensure-1PasswordCLIInPath {
  $opCmd = Get-Command op -ErrorAction SilentlyContinue
  if ($opCmd) {
    Write-Host ("[INFO] op (1Password CLI) already in PATH at {0}" -f $opCmd.Source)
    return $true
  }

  # Standard installation location for 1Password CLI via winget
  $opCliPath = Join-Path $env:ProgramFiles '1Password CLI'
  $opExe = Join-Path $opCliPath 'op.exe'

  if (Test-Path $opExe) {
    Add-ToPathIfNeeded -Dir $opCliPath
    Write-Host ("[INFO] Found op.exe at '{0}'" -f $opExe)
    return $true
  }

  Write-Host "[ERROR] 1Password CLI (op.exe) not found. Ensure 'AgileBits.1Password.CLI' is installed via winget." -ForegroundColor Red
  return $false
}

function Ensure-1PasswordInPath {
  $onePasswordCmd = Get-Command 1Password -ErrorAction SilentlyContinue
  if ($onePasswordCmd) {
    Write-Host ("[INFO] 1Password executable detected in PATH at {0}" -f $onePasswordCmd.Source)
  } else {
    $1passwordAppPath = Get-ChildItem -Path "$env:LOCALAPPDATA\1Password\app" -Directory -ErrorAction SilentlyContinue |
      Sort-Object Name -Descending | Select-Object -First 1

    if ($1passwordAppPath -and (Test-Path (Join-Path $1passwordAppPath.FullName '1Password.exe'))) {
      Add-ToPathIfNeeded -Dir $1passwordAppPath.FullName
      Write-Host ("[INFO] Added 1Password (version {0}) to PATH." -f $1passwordAppPath.Name)
    } else {
      # 1Password GUI might be installed via MS Store or in a different location - not fatal if CLI works
      Write-Host "[INFO] 1Password GUI not in standard location (may be MS Store install)."
    }
  }

  # Ensure the CLI is in PATH - this is required
  if (-not (Ensure-1PasswordCLIInPath)) {
    exit 1
  }
}

Ensure-1PasswordInPath

function Invoke-OpWithRetry {
  param([string[]]$Args, [int]$MaxRetries = 3, [int]$DelaySeconds = 2)

  for ($i = 1; $i -le $MaxRetries; $i++) {
    $result = & op @Args 2>&1
    if ($LASTEXITCODE -eq 0) {
      return @{ Success = $true; Output = $result }
    }

    # Check if it's a connection error worth retrying
    $resultStr = $result | Out-String
    if ($resultStr -match 'cannot connect to 1Password app|error initializing client') {
      if ($i -lt $MaxRetries) {
        Write-Host ("[INFO] 1Password connection not ready, retrying in {0}s... (attempt {1}/{2})" -f $DelaySeconds, $i, $MaxRetries)
        Start-Sleep -Seconds $DelaySeconds
        continue
      }
    }

    return @{ Success = $false; Output = $result }
  }

  return @{ Success = $false; Output = $result }
}

function Ensure-OpSshKey {
  param([string]$Title, [string]$Purpose)
  Write-Host ("[INFO] Checking for SSH key '{0}' in 1Password..." -f $Title)

  $opResult = Invoke-OpWithRetry -Args @('item', 'get', $Title, '--fields', 'public key')
  if ($opResult.Success -and $opResult.Output) {
    Write-Host ("[INFO] SSH key '{0}' found in 1Password." -f $Title)
    try {
      $creationDate = op item get $Title --fields 'Creation Date' 2>$null
      if ($creationDate) { Write-Host ("    Created: {0}" -f $creationDate) }
    } catch {}
    return
  }

  # Show the actual error if op failed
  if ($opResult.Output) {
    Write-Host ("[DEBUG] op returned: {0}" -f $opResult.Output) -ForegroundColor Gray
  }

  Write-Host ("[WARN] SSH key '{0}' not found in 1Password." -f $Title) -ForegroundColor Yellow
  Write-Host ""
  $createKey = Read-Host (" Would you like to create '{0}' now? (y/N)" -f $Title)
  if ($createKey -match "^[Yy]$") {
    Write-Host (" Creating new Ed25519 key: {0}..." -f $Title)
    $creationDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC")
    try {
      op item create --category 'SSH Key' --title $Title --ssh-generate-key ed25519 ("Creation Date[text]={0}" -f $creationDate) ("Purpose[text]={0}" -f $Purpose) *>$null
      Write-Host " [OK] SSH key created successfully!"
      Write-Host ""
      Write-Host (" [KEY] Public key for GitHub ({0}):" -f $Title)
      Write-Host "========================================================================="
      op item get $Title --fields 'public key'
      Write-Host "========================================================================="
      Write-Host ""
      Write-Host ' Next steps - Add this key to GitHub TWICE:'
      Write-Host '  1. Go to https://github.com/settings/keys'
      Write-Host '  2. Click "New SSH key" -> Add as "Authentication Key"'
      Write-Host '  3. Click "New SSH key" again -> Add as "Signing Key"'
      Write-Host ""
      Write-Host -NoNewline ' Press any key after adding the key to GitHub (both auth & signing)...'
      $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
      Write-Host ""
    } catch {
      Write-Host (" Failed to create SSH key '{0}'." -f $Title)
      Write-Host (" Machine setup requires '{0}'. Exiting now..." -f $Title)
      exit 1
    }
  } else {
    Write-Host ("[RED] Skipping '{0}' creation. Machine setup requires this key. Exiting now..." -f $Title)  -ForegroundColor Red
    exit 1
  }
}

function Get-ActualUser {
  # When running as admin, $env:USERNAME is the admin account, not the actual user.
  # Get the actual user from USERPROFILE path
  $userFromProfile = Split-Path $env:USERPROFILE -Leaf
  return $userFromProfile
}

function Check-Key {
  param([string]$Priv,[string]$Pub)

  $privExists = Test-Path $Priv
  $pubExists = Test-Path $Pub

  if ($privExists -and $pubExists) {
    Write-Host ("[INFO] found existing SSH key pair: {0} / {1}" -f $Priv, $Pub)
    return $true
  }

  return $false
}

function Ensure-Key {
  param([string]$Title,[string]$Priv,[string]$Pub)
  $actualUser = Get-ActualUser

  $privResult = Invoke-OpWithRetry -Args @('item', 'get', $Title, '--fields', 'private key', '--reveal')
  if ($privResult.Success -and $privResult.Output) {
    # Remove surrounding quotes if present (PowerShell op output may include them)
    $privKey = ($privResult.Output | Out-String).Trim('"').Trim()
    Set-Content -Path $Priv -Value $privKey -Encoding ascii -NoNewline
    try { icacls $Priv /inheritance:r *>$null; icacls $Priv /grant:r "${actualUser}:(R,W)" *>$null } catch {}

    $pubResult = Invoke-OpWithRetry -Args @('item', 'get', $Title, '--fields', 'public key', '--reveal')
    if ($pubResult.Success -and $pubResult.Output) {
      $pubKey = ($pubResult.Output | Out-String).Trim('"').Trim()
      Set-Content -Path $Pub -Value $pubKey -Encoding ascii -NoNewline
    }
    Write-Host ("[INFO] wrote {0} (+ .pub if available)" -f $Priv)
  } else {
    Write-Host ("[ERROR] Could not read '{0}' private key from 1Password." -f $Title) -ForegroundColor Red
    if ($privResult.Output) {
      Write-Host ("[DEBUG] op returned: {0}" -f $privResult.Output) -ForegroundColor Gray
    }
  }
}

try {

  $sshDir = Join-Path $env:USERPROFILE '.ssh'
  New-Item -ItemType Directory -Path $sshDir -Force *>$null

  $devPriv = Join-Path $sshDir 'id_ed25519_dev'
  $devPub  = Join-Path $sshDir 'id_ed25519_dev.pub'
  $workPriv = Join-Path $sshDir 'id_ed25519_work'
  $workPub  = Join-Path $sshDir 'id_ed25519_work.pub'

  $keysExist = Check-Key -Priv $devPriv -Pub $devPub
  {{- if .is_work_machine }}
  if ($keysExist) {
    $keysExist = Check-Key -Priv $workPriv -Pub $workPub
  }
  {{- end }}
  
  if ($keysExist) {
    exit 0
  }

  Write-Host '[INFO] Opening 1Password...'

  try {
    Start-Process '1Password.exe' -ErrorAction Stop
    Write-Host '[INFO] 1Password is starting...'
  } catch {
    Write-Host ('[WARN] Could not automatically open 1Password: {0} ' -f $_.Exception.Message) -ForegroundColor Yellow
    Write-Host ('[WARN] Please open 1Password manually now.') -ForegroundColor Yellow
  }

  Write-Host ""
  Write-Host ' In 1Password, please enable these settings:'
  Write-Host '  1. Settings -> Developer -> [x] "Integrate with 1Password CLI"'
  Write-Host '  2. Ensure 1Password is unlocked'
  Write-Host ""
  Write-Host -NoNewline ' Press any key when finished...'
  $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
  Write-Host ""

  # Give 1Password a moment to stabilize after settings changes
  Write-Host "[INFO] Waiting for 1Password to be ready..."
  Start-Sleep -Seconds 3

  # Verify op CLI is working
  $accountResult = op account list 2>&1
  if ($LASTEXITCODE -ne 0) {
    Write-Host "[ERROR] 'op account list' failed:" -ForegroundColor Red
    Write-Host $accountResult -ForegroundColor Red
    Write-Host ""
    Write-Host "Ensure 1Password CLI integration is enabled:" -ForegroundColor Yellow
    Write-Host "  1. Open 1Password -> Settings -> Developer" -ForegroundColor Yellow
    Write-Host "  2. Check 'Integrate with 1Password CLI'" -ForegroundColor Yellow
    exit 1
  }

  Write-Host "[INFO] 1Password CLI connected. Available accounts:"
  Write-Host $accountResult

  Ensure-OpSshKey -Title 'Dev SSH Key' -Purpose 'Development machine SSH authentication and Git signing'
  {{- if .is_work_machine }}
  Ensure-OpSshKey -Title 'Work SSH Key' -Purpose 'Work machine SSH authentication and Git signing'
  {{- end }}

  Ensure-Key -Title "Dev SSH Key" -Priv $devPriv -Pub $devPub
  {{- if .is_work_machine }}
  Ensure-Key -Title "Work SSH Key" -Priv $workPriv -Pub $workPub
  {{- end }}

  Write-Host '[INFO] Checking for SSH hosts configuration...'
  try {
    op item get 'ssh-hosts' --fields 'hosts' *>$null
    Write-Host ('[INFO] SSH hosts configuration found in 1Password.')
  } catch {
    Write-Host ("[ERROR] SSH hosts configuration '{0}' not found." -f 'ssh-hosts') -ForegroundColor Red
  }

} catch {
  Write-Host ""
  Write-Host ('[ERROR] Unexpected error during 1Password setup: {0}' -f $_.Exception.Message) -ForegroundColor Red
  Write-Host ('[ERROR] Machine setup cannot continue without 1Password integration.') -ForegroundColor Red
  exit 1
}
