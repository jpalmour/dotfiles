#!/bin/bash

set -eufo pipefail

{{- $packages := (default (list) .linux_apt_packages) | sortAlpha | uniq -}}
{{- $snapPackagesNonWsl := (default (list) .linux_snap_packages_non_wsl) | sortAlpha | uniq -}}
{{- $snapPackagesWsl := (default (list) .linux_snap_packages_wsl) | sortAlpha | uniq -}}
{{- $classicSnapPackagesNonWsl := (default (list) .linux_classic_snap_packages_non_wsl) | sortAlpha | uniq -}}
{{- $snaps := list -}}
{{- $classicSnaps := list -}}
{{- if .is_wsl -}}
{{-   $snaps = $snapPackagesWsl -}}
{{- else -}}
{{-   $snaps = $snapPackagesNonWsl -}}
{{-   $classicSnaps = $classicSnapPackagesNonWsl -}}
{{- end }}

sudo apt-get update
sudo apt-get install -y {{ $packages | join " " }}

# Set zsh as the default shell if not already
if [ "$(getent passwd "$USER" | awk -F: '{print $7}')" != "$(command -v zsh)" ]; then
  echo " Setting default shell to zsh..."
  sudo chsh -s "$(command -v zsh)" "$USER" || true
fi

{{- if not .is_wsl }}
# Configure SSH server
if command -v systemctl >/dev/null 2>&1; then
  echo " Configuring SSH server..."
  sudo systemctl enable ssh >/dev/null 2>&1 || true
  sudo systemctl start ssh >/dev/null 2>&1 || true

  # Configure firewall if ufw is installed
  if command -v ufw >/dev/null 2>&1; then
    sudo ufw allow ssh >/dev/null 2>&1 || true
  fi
fi
{{- end }}

if command -v snap >/dev/null 2>&1; then
{{ range $snaps -}}
  ( snap info {{ . }} | grep -q ^installed: ) || sudo snap install {{ . }}
{{ end -}}
{{ range $classicSnaps -}}
  ( snap info {{ . }} | grep -q ^installed: ) || sudo snap install --classic {{ . }}
{{ end -}}
fi

{{- if not .is_wsl }}
echo " Ensuring Docker Engine is installed..."
sudo install -m 0755 -d /etc/apt/keyrings

TMP_DOCKER_ASC=$(mktemp)
TMP_DOCKER_GPG=$(mktemp)
curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o "$TMP_DOCKER_ASC"
gpg --dearmor --output "$TMP_DOCKER_GPG" "$TMP_DOCKER_ASC"

docker_repo_updated=0
if [ ! -f /etc/apt/keyrings/docker.gpg ] || ! sudo cmp -s "$TMP_DOCKER_GPG" /etc/apt/keyrings/docker.gpg; then
  sudo install -m 0644 "$TMP_DOCKER_GPG" /etc/apt/keyrings/docker.gpg
  docker_repo_updated=1
fi
rm -f "$TMP_DOCKER_ASC" "$TMP_DOCKER_GPG"

. /etc/os-release
UBUNTU_CODENAME="${UBUNTU_CODENAME:-${VERSION_CODENAME}}"
ARCH=$(dpkg --print-architecture)
DOCKER_LIST=/etc/apt/sources.list.d/docker.list
DOCKER_LINE="deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${UBUNTU_CODENAME} stable"

if [ ! -f "$DOCKER_LIST" ] || ! grep -Fxq "$DOCKER_LINE" "$DOCKER_LIST"; then
  echo "$DOCKER_LINE" | sudo tee "$DOCKER_LIST" >/dev/null
  docker_repo_updated=1
fi

if [ "${docker_repo_updated}" -eq 1 ]; then
  sudo apt-get update
fi

sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

sudo systemctl enable docker >/dev/null 2>&1 || true
sudo systemctl start docker >/dev/null 2>&1 || true

# Add user to docker group for non-root docker access
sudo usermod -aG docker "$USER" || true
echo " Installing Google Chrome..."
if ! command -v google-chrome >/dev/null 2>&1; then
  TMP_CHROME_KEY=$(mktemp)
  curl -fsSL https://dl.google.com/linux/linux_signing_key.pub -o "$TMP_CHROME_KEY"
  sudo gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg "$TMP_CHROME_KEY" 2>/dev/null || true
  rm -f "$TMP_CHROME_KEY"

  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/google-chrome.gpg] https://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list >/dev/null
  sudo apt-get update
  sudo apt-get install -y google-chrome-stable
else
  echo " Google Chrome already installed, skipping."
fi

{{- else }}
echo " Skipping Docker Engine installation under WSL; use Docker Desktop integration."
{{- end }}

echo "Installing/upgrading Claude Code via native installer..."
if ! curl -fsSL https://claude.ai/install.sh | bash; then
  echo "Warning: Claude Code installer failed." >&2
fi
