# PowerShell profile (current user, all hosts)
# Ensures core productivity modules and Oh My Posh prompt are available.

$localBin = Join-Path $HOME ".local\bin"
if (-not (Test-Path $localBin)) {
    New-Item -ItemType Directory -Path $localBin -Force | Out-Null
}

$pathEntries = $env:Path -split ';'
if (-not ($pathEntries | Where-Object { $_.TrimEnd('\') -ieq $localBin })) {
    $env:Path = "$localBin;$env:Path"
}

# Add global Python venv to PATH for globally installed packages
$globalVenv = Join-Path $HOME ".venv-global\Scripts"
if (Test-Path $globalVenv) {
    $pathEntries = $env:Path -split ';'
    if (-not ($pathEntries | Where-Object { $_.TrimEnd('\') -ieq $globalVenv })) {
        $env:Path = "$globalVenv;$env:Path"
    }
}

# Load essential modules if present. Missing modules are non-fatal; install script handles setup.
foreach ($moduleName in @('PSReadLine', 'posh-git', 'Terminal-Icons')) {
    try {
        if (-not (Get-Module -Name $moduleName)) {
            Import-Module -Name $moduleName -ErrorAction Stop
        }
    } catch {
        Write-Verbose ("Failed to import module '{0}': {1}" -f $moduleName, $_.Exception.Message)
    }
}

# Configure PSReadLine for a smoother interactive experience.
if (Get-Module -ListAvailable -Name 'PSReadLine') {
    Set-PSReadLineOption -EditMode Windows
    if ($host.Name -eq 'ConsoleHost' -and -not [Console]::IsOutputRedirected) {
        Set-PSReadLineOption -PredictionSource History
        Set-PSReadLineOption -PredictionViewStyle ListView
    }
    Set-PSReadLineOption -Colors @{
        Parameter = '#26C6DA'  # Cyan matching theme for better contrast
    }
}

# Initialize Oh My Posh if available.
$ompCommand = Get-Command 'oh-my-posh.exe' -ErrorAction SilentlyContinue
if (-not $ompCommand) {
    $ompCommand = Get-Command 'oh-my-posh' -ErrorAction SilentlyContinue
}

if ($ompCommand) {
    $ompConfig = Join-Path $HOME '.theme.omp.json'
    try {
        & $ompCommand.Name init pwsh --config $ompConfig | Invoke-Expression
    } catch {
        Write-Verbose ("Failed to initialize oh-my-posh: {0}" -f $_.Exception.Message)
    }
} else {
    Write-Verbose 'oh-my-posh not found on PATH.'
}

# No additional configuration needed; Terminal-Icons initialization happens on import.

{{- if .is_work_machine }}
# Work-specific aliases (work machine only)
if ($env:WORK_ALIASES_PATH -and (Test-Path $env:WORK_ALIASES_PATH)) {
    . $env:WORK_ALIASES_PATH
} else {
    Write-Verbose 'WORK_ALIASES_PATH not set or file not found.'
}
{{- end }}

# Chezmoi aliases
function ca { chezmoi apply }
function ca-all {
    $env:CHEZMOI_INCLUDE_SSH = "1"
    chezmoi apply
}
