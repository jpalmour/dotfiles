# PowerShell - Windows only
$ErrorActionPreference = "Stop"
Write-Host "[bootstrap] start on windows"

# Ensure repos folder
$repos = Join-Path $HOME "repos\github.com\jpalmour"
New-Item -ItemType Directory -Force -Path $repos | Out-Null

# Choose email (prefer work on work machines)
$email = "{{- if and .is_work_machine (ne .work_email ``) -}}{{ .work_email }}{{- else -}}{{ .personal_email }}{{- end -}}"

# SSH key (ed25519) if OpenSSH client is installed
$sshDir = Join-Path $HOME ".ssh"
$keyPath = Join-Path $sshDir "id_ed25519"
if (!(Test-Path $keyPath)) {
  Write-Host "[bootstrap] generating SSH key for $email ..."
  New-Item -ItemType Directory -Force -Path $sshDir | Out-Null
  icacls $sshDir /inheritance:r /grant:r "$($env:UserName):(OI)(CI)F" | Out-Null
  ssh-keygen -t ed25519 -C "$email" -f $keyPath -N ""
}

# Delegate to Windows setup
$winSetup = Join-Path "{{ .chezmoi.sourceDir }}" "windows\run_once_010_windows_setup.ps1"
if (Test-Path $winSetup) {
  & $winSetup
}

echo "[bootstrap] installing/upgrading AI CLI tools via npm..."

# Load nvm (installed by the OS-specific 010 script)
if [ -s "$HOME/.nvm/nvm.sh" ]; then
  . "$HOME/.nvm/nvm.sh"
else
  echo "[bootstrap] ERROR: nvm not found at ~/.nvm/nvm.sh; ensure 010 script installed it." >&2
  exit 1
fi

nvm install --lts
nvm use --lts

npm install -g @openai/codex claude-code @google/gemini-cli

echo "[bootstrap] AI CLIs done âœ…"

Write-Host "[bootstrap] done."
