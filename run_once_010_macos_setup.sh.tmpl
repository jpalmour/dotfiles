#!/usr/bin/env bash
set -euo pipefail

echo "[macos] bootstrap starting..."

# --- Ensure Homebrew is installed ---
if ! command -v brew >/dev/null 2>&1; then
  echo "[macos] installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  # make sure brew is on PATH
  eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || true
  eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
fi

# --- Base CLI tools
echo "[macos] installing base CLI tools..."
brew install \
  git \
  curl \
  wget \
  vim \
  tmux \
  tree \
  jq \
  ripgrep \
  coreutils \
  gnu-sed \
  make

# --- Zsh ---
if ! command -v zsh >/dev/null 2>&1; then
  echo "[macos] installing zsh..."
  brew install zsh
fi

# oh-my-zsh (same shared logic, embedded here for single-pass bootstrap)
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  echo "[macos] installing oh-my-zsh..."
  RUNZSH=no CHSH=no KEEP_ZSHRC=yes \
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

# Make zsh default shell
if [ "$SHELL" != "$(command -v zsh)" ]; then
  echo "[macos] setting default shell to zsh..."
  chsh -s "$(command -v zsh)"
fi

# --- GUI apps (brew cask) matching your Ubuntu list ---
echo "[macos] installing GUI apps (casks)..."
brew install --cask \
  google-chrome \
  slack \
  ghostty \
  1password \
  docker

# --- Developer/AI tools ---
echo "[macos] installing developer/AI tools..."

# nvm (via brew, simpler than curl script here)
if ! command -v nvm >/dev/null 2>&1; then
  brew install nvm
  mkdir -p ~/.nvm
  grep -q 'NVM_DIR' ~/.zprofile 2>/dev/null || cat >> ~/.zprofile <<'EOF'

# nvm setup (added by chezmoi bootstrap)
export NVM_DIR="$HOME/.nvm"
[ -s "$(brew --prefix nvm)/nvm.sh" ] && \. "$(brew --prefix nvm)/nvm.sh"
EOF
fi

echo "[macos] bootstrap done âœ…"

