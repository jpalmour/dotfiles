{{- /* Commit signing with SSH (via 1Password) */}}
{{- if lookPath "op" }}
  {{- /* Only render signing config when op is available. */}}
  {{- /* Determine if the 1Password item exists without failing the template. */}}
  {{- $status := "" -}}
  {{- if eq .chezmoi.os "windows" -}}
    {{- $status = (output "powershell" "-NoProfile" "-Command" "if (op item get \"Dev SSH Key\" --fields \"public key\" *> $null) { 'present' } else { 'missing' }") -}}
  {{- else -}}
    {{- $status = (trim (output "sh" "-c" "command -v op >/dev/null 2>&1 && op item get 'Dev SSH Key' --format json >/dev/null 2>&1 && echo present || echo missing")) -}}
  {{- end -}}
  {{- if eq $status "present" -}}
    {{- $sshItem := onepasswordItemFields "Dev SSH Key" -}}
    {{- $pub := index $sshItem "Public Key" -}}
    {{- if $pub }}
[gpg]
    format = ssh
    {{- /* OS-specific path to op-ssh-sign */}}
    {{- if eq .chezmoi.os "darwin" }}
    ssh.program = /Applications/1Password.app/Contents/MacOS/op-ssh-sign
    {{- else if eq .chezmoi.os "linux" }}
    ssh.program = /opt/1Password/op-ssh-sign
    {{- else if eq .chezmoi.os "windows" }}
    ssh.program = op-ssh-sign.exe
    {{- else }}
    ssh.program = op-ssh-sign
    {{- end }}

[commit]
    gpgSign = true

[user]
    signingkey = {{ $pub }}
    {{- else }}
  # 1Password CLI found but 'Dev SSH Key' missing 'Public Key' field; skipping signing config.
    {{- end }}
  {{- else }}
  # 1Password CLI present but item 'Dev SSH Key' not found; skipping signing config for now.
  {{- end -}}
{{- else }}
# 1Password CLI not yet installed; skipping signing config for now.
{{- end }}

# --- Platform niceties ---
{{- if eq .chezmoi.os "windows" }}
# Use Microsoft OpenSSH so 1Passwordâ€™s agent works smoothly
[core]
    sshCommand = C:\\Windows\\System32\\OpenSSH\\ssh.exe
{{- end }}

[user]
    name = Joseph Palmour
    email = {{ if and .is_work_machine (ne .work_email ``) -}}{{ .work_email }}{{- else -}}{{ .personal_email }}{{- end }}
